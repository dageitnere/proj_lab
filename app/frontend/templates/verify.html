<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Email Verification</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 420px; margin: 6rem auto; padding: 0 1rem; }
    form { display: grid; gap: .75rem; }
    label { display: grid; gap: .25rem; }
    input { padding: .6rem .7rem; border: 1px solid #bbb; border-radius: .5rem; }
    button { padding: .7rem .9rem; border: 0; border-radius: .6rem; background:#2255ee; color:#fff; cursor:pointer; }
    .msg { min-height: 1.2rem; margin-top:.5rem; }
    .ok { color:#0a7a26; } .err { color:#b40018; }
  </style>
</head>
<body>
  <h1>Email Verification</h1>

  <!-- Enter email once -->
  <form id="start">
    <label>Email
      <input name="email" type="email" required />
    </label>
    <button type="submit">Send Code</button>
    <div class="msg" id="m1"></div>
  </form>

  <hr style="margin:1rem 0">

  <!-- Only code here; we reuse the stored email -->
  <form id="confirm">
    <label>Verification Code (6 digits)
      <input name="code" inputmode="numeric" pattern="\d{6}" maxlength="6" required />
    </label>
    <button type="submit">Confirm</button>
    <div class="msg" id="m2"></div>
  </form>

  <p style="margin-top:.5rem"><a href="/auth/login">Back to Login</a></p>

  <script>
  function getStoredEmail() {
    const qp = new URL(location.href).searchParams.get('email');
    if (qp) { sessionStorage.setItem('verify_email', qp); return qp; }
    const st = sessionStorage.getItem('verify_email');
    if (st) return st;
    return '';
  }

  // Prefill email if available
  (function init() {
    const e = getStoredEmail();
    if (e) document.querySelector('#start [name=email]').value = e;
  })();

  // Send code
  document.getElementById('start').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const f = ev.target, m = document.getElementById('m1');
    m.textContent = '';
    const email = f.email.value.trim();
    sessionStorage.setItem('verify_email', email);
    const r = await fetch('/auth/verification/start', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email })
    });
    m.textContent = r.ok ? 'Verification code sent.' : 'Failed to send code.';
    m.className = 'msg ' + (r.ok ? 'ok' : 'err');
    if (r.ok) document.querySelector('#confirm [name=code]').focus();
  });

  // Confirm code using stored email
  document.getElementById('confirm').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const f = ev.target, m = document.getElementById('m2');
    m.textContent = '';
    const email = getStoredEmail() || document.querySelector('#start [name=email]').value.trim();
    if (!email) { m.textContent = 'Email required.'; m.className = 'msg err'; return; }

    const r = await fetch('/auth/verification/confirm', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email, code: f.code.value.trim() })
    });

    if (r.ok) {
      m.textContent = 'Email verified. Complete the registration.';
      m.className = 'msg ok';
      setTimeout(() => location.href = '/auth/complete', 1200);
      // optional: sessionStorage.removeItem('verify_email');
    } else {
      const j = await r.json().catch(() => ({detail: 'Invalid or expired code.'}));
      m.textContent = j.detail || 'Invalid or expired code.';
      m.className = 'msg err';
    }
  });
  </script>
</body>
</html>